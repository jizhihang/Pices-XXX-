<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Pices: D:/Users/kkramer/IEC/SipperSoftware/BaseLibrary/Compressor.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pices
   &#160;<span id="projectnumber">1.82</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_compressor_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Compressor.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_compressor_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Compressor.cpp -- Compresses and decompresses data using zLib Library</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * Copyright (C) 1994-2011 Kurt Kramer</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * For conditions of distribution and use, see copyright notice in KKU.h</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_first_includes_8h.html">FirstIncludes.h</a>&quot;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_memory_debug_8h.html">MemoryDebug.h</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#ifdef  WIN32</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include  &quot;zlib.h&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_compressor_8h.html">Compressor.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_global_goal_keeper_8h.html">GlobalGoalKeeper.h</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_base_library_2_o_sservices_8h.html">OSservices.h</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">using namespace </span>KKU;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno"><a class="code" href="class_k_k_u_1_1_compressor.html#ad2d3fd70726ef5577195fb2b894c8a81">   21</a></span>&#160;<span class="keywordtype">void</span>*  Compressor::CreateCompressedBuffer (<span class="keywordtype">void</span>*  source,</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;                                           <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a> sourceLen,</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;                                           <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>&amp;  compressedBuffLen</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;                                          )</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;{</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#ifdef ZLIB_H</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  <span class="comment">// following code was lifted from example proided by zlib  &quot;zpipe.c&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  <a class="code" href="namespace_k_k_u.html#a8b7fc4cab23c3008e81c694b382bcfd2">int32</a>     ret;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  z_stream  strm;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  Bytef*  outputBuffer = NULL;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>  outputBufferSize = sourceLen * 2;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  outputBuffer = <span class="keyword">new</span> Bytef[outputBufferSize];</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>*  compressedBuff = NULL;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  compressedBuffLen     = 0;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="comment">//  The first thing we do is to initialize the zlib state for compression using deflateInit(). This must be done before the first use of deflate(). The zalloc, zfree, and opaque fields in the strm structure must be initialized before calling deflateInit(). Here they are set to the zlib constant Z_NULL to request that zlib use the default memory allocation routines. An application may also choose to provide custom memory allocation routines here. deflateInit() will allocate on the order of 256K bytes for the internal state. (See zlib Technical Details.) </span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="comment">// deflateInit() is called with a pointer to the structure to be initialized and the compression level, which is an integer in the range of -1 to 9. Lower compression levels result in faster execution, but less compression. Higher levels result in greater compression, but slower execution. The zlib constant Z_DEFAULT_COMPRESSION, equal to -1, provides a good compromise between compression and speed and is equivalent to level 6. Level 0 actually does no compression at all, and in fact expands the data slightly to produce the zlib format (it is not a byte-for-byte copy of the input). More advanced applications of zlib may use deflateInit2() here instead. Such an application may want to reduce how much memory will be used, at some price in compression. Or it may need to request a gzip header and trailer instead of a zlib header and trailer, or raw encoding with no header or trailer at all. </span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="comment">// We must check the return value of deflateInit() against the zlib constant Z_OK to make sure that it was able to allocate memory for the internal state, and that the provided arguments were valid. deflateInit() will also check that the version of zlib that the zlib.h file came from matches the version of zlib actually linked with the program. This is especially important for environments in which zlib is a shared library. </span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="comment">// Note that an application can initialize multiple, independent zlib streams, which can operate in parallel. The state information maintained in the structure allows the zlib routines to be reentrant. </span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="comment">/* allocate deflate state */</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  strm.zalloc  = Z_NULL;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  strm.zfree   = Z_NULL;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  strm.opaque  = Z_NULL;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  ret = deflateInit (&amp;strm, Z_DEFAULT_COMPRESSION);   <span class="comment">// &#39;Z_DEFAULT_COMPRESSION&#39; will balance between speed and compression;  0 = no compression,  9 = best compression</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keywordflow">if</span>  (ret != Z_OK)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// Initialization Failed</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    compressedBuffLen = 0;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  }</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="comment">//  With the pleasantries out of the way, now we can get down to business. The outer do-loop reads all of the input file and exits at the bottom of the loop once end-of-file is reached. This loop contains the only call of deflate(). So we must make sure that all of the input data has been processed and that all of the output data has been generated and consumed before we fall out of the loop at the bottom.</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  {</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// This was originally a a loop that read from a file;  but now we have a input buffer with a known amount of data.</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    strm.avail_in = sourceLen;       <span class="comment">// Number of bytes in &#39;source&#39;  to compress.</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    strm.next_in  = (Bytef*)source;  <span class="comment">// pointer to data that needs to be compressed.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    { </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;      <span class="comment">// We will stay in this loop until all data in source is processed.  If the output buffer is not large enough </span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;      <span class="comment">// we may need to make more than one iteration.</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      strm.avail_out = outputBufferSize;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;      strm.next_out  = outputBuffer;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;      <span class="comment">// Now we call the compression engine itself, deflate(). It takes as many of the avail_in bytes at next_in as it can process, and writes as many as avail_out bytes to next_out. Those counters and pointers are then updated past the input data consumed and the output data written. It is the amount of output space available that may limit how much input is consumed. Hence the inner loop to make sure that all of the input is consumed by providing more output space each time. Since avail_in and next_in are updated by deflate(), we don&#39;t have to mess with those between deflate() calls until it&#39;s all used up. </span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;      <span class="comment">// The parameters to deflate() are a pointer to the strm structure containing the input and output information and the internal compression engine state, and a parameter indicating whether and how to flush data to the output. Normally deflate will consume several K bytes of input data before producing any output (except for the header), in order to accumulate statistics on the data for optimum compression. It will then put out a burst of compressed data, and proceed to consume more input before the next burst. Eventually, deflate() must be told to terminate the stream, complete the compression with provided input data, and write out the trailer check value. deflate() will continue to compress normally as long as the flush parameter is Z_NO_FLUSH. Once the Z_FINISH parameter is provided, deflate() will begin to complete the compressed output stream. However depending on how much output space is provided, deflate() may have to be called several times until it has provided the complete compressed stream, even after it has consumed all of the input. The flush parameter must continue to be Z_FINISH for those subsequent calls. </span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;      ret = deflate (&amp;strm, Z_FINISH);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      <span class="keywordflow">if</span>  (ret == Z_STREAM_ERROR)</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot;Compressor::CreateCompressedBuffer  ***ERROR**   defalte returned error[&quot;</span> &lt;&lt; ret &lt;&lt; <span class="stringliteral">&quot;].&quot;</span> &lt;&lt; <a class="code" href="namespace_k_k_u.html#a881aad079a3116955797c32d6bba38ad">std::endl</a>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        compressedBuffLen = 0;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;      }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;      <span class="comment">// Now we compute how much output deflate() provided on the last call, which is the difference between how much space was provided before the call, and how much output space is still available after the call. Then that data, if any, is written to the output file. We can then reuse the output buffer for the next call of deflate(). Again if there is a file i/o error, we call deflateEnd() before returning to avoid a memory leak. </span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      <a class="code" href="namespace_k_k_u.html#a8b7fc4cab23c3008e81c694b382bcfd2">int32</a> have = outputBufferSize - strm.avail_out;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="keywordflow">if</span>  (compressedBuff == NULL)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        {</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;          compressedBuff = <span class="keyword">new</span> <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>[have];</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;          compressedBuffLen = have;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;          memcpy (compressedBuff, outputBuffer, have);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        {</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;          <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>  newCompressedBuffLen = compressedBuffLen + have;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;          <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>*  newCompressedBuff = <span class="keyword">new</span> <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>[newCompressedBuffLen];</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;          memcpy (newCompressedBuff, compressedBuff, compressedBuffLen);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;          memcpy (newCompressedBuff + compressedBuffLen, outputBuffer, have);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;          <span class="keyword">delete</span>  compressedBuff;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;          compressedBuff    = newCompressedBuff;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;          compressedBuffLen = newCompressedBuffLen;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        }</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;      }</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    } <span class="keywordflow">while</span> (strm.avail_out == 0);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;   </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordflow">if</span>  (strm.avail_in != 0)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      <span class="comment">// There is still input data;  so something went wrong. We will print a diagnostic message and return NULL</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Compressor::CreateCompressedBuffer   -  The input buffer was not fully processed.&quot;</span> &lt;&lt; <a class="code" href="namespace_k_k_u.html#a881aad079a3116955797c32d6bba38ad">std::endl</a>;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      <span class="keyword">delete</span>  compressedBuff;  compressedBuff  = NULL;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      <span class="keyword">delete</span>  outputBuffer;    outputBuffer    = NULL;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <span class="keywordflow">return</span>  NULL;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="comment">// The process is complete, but we still need to deallocate the state to avoid a memory leak (or rather more like a memory hemorrhage if you didn&#39;t do this). Then finally we can return with a happy return value. </span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="comment">/* clean up and return */</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160; (void)deflateEnd (&amp;strm);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160; <span class="keyword">delete</span>  outputBuffer;  outputBuffer = NULL;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; <span class="keywordflow">return</span>  compressedBuff;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor"></span> <span class="comment">// For right now the linux version will not be doing compression.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; <span class="keywordflow">return</span>  NULL;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="preprocessor"></span>}   <span class="comment">/* CreateCompressedBuffer*/</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno"><a class="code" href="class_k_k_u_1_1_compressor.html#a06e17057e5d2fc0aebf57306ab3521ee">  137</a></span>&#160;<span class="keywordtype">void</span>*   Compressor::Decompress (<span class="keyword">const</span> <span class="keywordtype">void</span>*  compressedBuff,</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                                <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>       compressedBuffLen,</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                                <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>&amp;      unCompressedLen</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                               )</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;{</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="preprocessor">#ifdef ZLIB_H</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span>  (compressedBuff == NULL)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">return</span>  NULL;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  GlobalGoalKeeper::StartBlock ();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <a class="code" href="namespace_k_k_u.html#a4ff1114b599601199298423d89e2cdaf">uint32</a>     have              = 0;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>*     unCompressedBuff  = NULL;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  Bytef*     outBuffer    = NULL;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <a class="code" href="namespace_k_k_u.html#a8b7fc4cab23c3008e81c694b382bcfd2">int32</a>      outBufferLen = 0;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <a class="code" href="namespace_k_k_u.html#a8b7fc4cab23c3008e81c694b382bcfd2">int32</a>      ret;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  z_stream   strm;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="comment">/* allocate inflate state */</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  strm.zalloc   = Z_NULL;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  strm.zfree    = Z_NULL;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  strm.opaque   = Z_NULL;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  strm.avail_in = 0;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  strm.next_in  = Z_NULL;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  ret = inflateInit (&amp;strm);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordflow">if</span>  (ret != Z_OK)</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Compressor::Decompress  ***ERROR***  zlib function call &#39;inflateInit&#39;  failed.&quot;</span> &lt;&lt; <a class="code" href="namespace_k_k_u.html#a881aad079a3116955797c32d6bba38ad">std::endl</a>;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    unCompressedLen = 0;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    GlobalGoalKeeper::EndBlock ();</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  outBufferLen = compressedBuffLen * 4;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  outBuffer    = <span class="keyword">new</span> Bytef[outBufferLen];</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  strm.avail_in = compressedBuffLen;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  strm.next_in  = (Bytef*)compressedBuff;  <span class="comment">// Bytef = a far pointer to a unsigned char.    </span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                                           <span class="comment">// Not sure if on some platforms this may cause a problem.</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="comment">/* run inflate() on input until output buffer not full */</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keywordflow">do</span> </div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  {</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    strm.avail_out = outBufferLen;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    strm.next_out  = outBuffer;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    ret = inflate (&amp;strm, Z_NO_FLUSH);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">if</span>  (ret == Z_STREAM_ERROR)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Compressor::Decompress  ***ERROR***  zlib function call &#39;inflate&#39;  failed.&quot;</span>  &lt;&lt; <a class="code" href="namespace_k_k_u.html#a881aad079a3116955797c32d6bba38ad">std::endl</a>;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      <span class="keyword">delete</span>  outBuffer;  outBuffer = NULL;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      <span class="keyword">delete</span>  unCompressedBuff;     unCompressedBuff    = NULL;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      unCompressedLen = 0;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      GlobalGoalKeeper::EndBlock ();</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">switch</span> (ret) </div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">case</span> Z_NEED_DICT:  ret = Z_DATA_ERROR;     <span class="comment">/* and fall through */</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordflow">case</span> Z_DATA_ERROR:</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">case</span> Z_MEM_ERROR:</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot;Compressor::Decompress  ***ERROR***  zlib function call &#39;inflate&#39;  failed.&quot;</span>  &lt;&lt; <a class="code" href="namespace_k_k_u.html#a881aad079a3116955797c32d6bba38ad">std::endl</a>;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        (void)inflateEnd (&amp;strm);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keyword">delete</span>  outBuffer;          outBuffer        = NULL;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keyword">delete</span>  unCompressedBuff;   unCompressedBuff = NULL;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        unCompressedLen = 0;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        GlobalGoalKeeper::EndBlock ();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      }</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    }</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    have = outBufferLen - strm.avail_out;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">if</span>  (unCompressedBuff == NULL)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      unCompressedBuff = <span class="keyword">new</span> <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>[have];</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      unCompressedLen = have;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      memcpy (unCompressedBuff, outBuffer, have);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    {</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      <a class="code" href="namespace_k_k_u.html#a8b7fc4cab23c3008e81c694b382bcfd2">int32</a>  newUnCompressedLen   = unCompressedLen + have;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>* newUnCompressedBuff  = <span class="keyword">new</span> <a class="code" href="namespace_k_k_u.html#a8f92ef880fd0850210d438f6a90e0b8f" title="Unsigned character. ">uchar</a>[newUnCompressedLen];</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      memcpy (newUnCompressedBuff, unCompressedBuff, unCompressedLen);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;      memcpy (newUnCompressedBuff + unCompressedLen, outBuffer, have);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      <span class="keyword">delete</span>  unCompressedBuff;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      unCompressedBuff = newUnCompressedBuff;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;      unCompressedLen = newUnCompressedLen;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      newUnCompressedBuff = NULL;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    }</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="keywordflow">while</span> (strm.avail_out == 0);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="comment">/* clean up and return */</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  (void)inflateEnd(&amp;strm);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keyword">delete</span>  outBuffer;</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  outBuffer = NULL;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  GlobalGoalKeeper::EndBlock ();</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="keywordflow">return</span>  unCompressedBuff;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor"></span>}  <span class="comment">/* Decompress */</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_2fc8af4ad960208b076ef9620da60455.html">BaseLibrary</a></li><li class="navelem"><a class="el" href="_compressor_8cpp.html">Compressor.cpp</a></li>
    <li class="footer">Generated on Wed Oct 15 2014 21:46:47 for Pices by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
